{"ast":null,"code":"\"use strict\";\n\n/*\n * Copyright 2021-2022 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nrequire(\"core-js/modules/es.array.push.js\");\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n      label: 0,\n      sent: function () {\n        if (t[0] & 1) throw t[1];\n        return t[1];\n      },\n      trys: [],\n      ops: []\n    },\n    f,\n    y,\n    t,\n    g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n        case 7:\n          op = _.ops.pop();\n          _.trys.pop();\n          continue;\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n            _.ops.push(op);\n            break;\n          }\n          if (t[2]) _.ops.pop();\n          _.trys.pop();\n          continue;\n      }\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.RSocketConnector = void 0;\nvar ClientServerMultiplexerDemultiplexer_1 = require(\"./ClientServerMultiplexerDemultiplexer\");\nvar Frames_1 = require(\"./Frames\");\nvar RSocketSupport_1 = require(\"./RSocketSupport\");\nvar Resume_1 = require(\"./Resume\");\nvar RSocketConnector = /** @class */function () {\n  function RSocketConnector(config) {\n    this.config = config;\n  }\n  RSocketConnector.prototype.connect = function () {\n    var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p, _q, _r, _s, _t, _u, _v;\n    return __awaiter(this, void 0, void 0, function () {\n      var config, setupFrame, connection, keepAliveSender, keepAliveHandler, leaseHandler, responder, connectionFrameHandler, streamsHandler;\n      var _this = this;\n      return __generator(this, function (_w) {\n        switch (_w.label) {\n          case 0:\n            config = this.config;\n            setupFrame = {\n              type: Frames_1.FrameTypes.SETUP,\n              dataMimeType: (_b = (_a = config.setup) === null || _a === void 0 ? void 0 : _a.dataMimeType) !== null && _b !== void 0 ? _b : \"application/octet-stream\",\n              metadataMimeType: (_d = (_c = config.setup) === null || _c === void 0 ? void 0 : _c.metadataMimeType) !== null && _d !== void 0 ? _d : \"application/octet-stream\",\n              keepAlive: (_f = (_e = config.setup) === null || _e === void 0 ? void 0 : _e.keepAlive) !== null && _f !== void 0 ? _f : 60000,\n              lifetime: (_h = (_g = config.setup) === null || _g === void 0 ? void 0 : _g.lifetime) !== null && _h !== void 0 ? _h : 300000,\n              metadata: (_k = (_j = config.setup) === null || _j === void 0 ? void 0 : _j.payload) === null || _k === void 0 ? void 0 : _k.metadata,\n              data: (_m = (_l = config.setup) === null || _l === void 0 ? void 0 : _l.payload) === null || _m === void 0 ? void 0 : _m.data,\n              resumeToken: (_p = (_o = config.resume) === null || _o === void 0 ? void 0 : _o.tokenGenerator()) !== null && _p !== void 0 ? _p : null,\n              streamId: 0,\n              majorVersion: 1,\n              minorVersion: 0,\n              flags: (((_r = (_q = config.setup) === null || _q === void 0 ? void 0 : _q.payload) === null || _r === void 0 ? void 0 : _r.metadata) ? Frames_1.Flags.METADATA : Frames_1.Flags.NONE) | (config.lease ? Frames_1.Flags.LEASE : Frames_1.Flags.NONE) | (config.resume ? Frames_1.Flags.RESUME_ENABLE : Frames_1.Flags.NONE)\n            };\n            return [4 /*yield*/, config.transport.connect(function (outbound) {\n              return config.resume ? new ClientServerMultiplexerDemultiplexer_1.ResumableClientServerInputMultiplexerDemultiplexer(ClientServerMultiplexerDemultiplexer_1.StreamIdGenerator.create(-1), outbound, outbound, new Resume_1.FrameStore(),\n              // TODO: add size control\n              setupFrame.resumeToken.toString(), function (self, frameStore) {\n                return __awaiter(_this, void 0, void 0, function () {\n                  var multiplexerDemultiplexerProvider, reconnectionAttempts, reconnector;\n                  return __generator(this, function (_a) {\n                    switch (_a.label) {\n                      case 0:\n                        multiplexerDemultiplexerProvider = function (outbound) {\n                          outbound.send({\n                            type: Frames_1.FrameTypes.RESUME,\n                            streamId: 0,\n                            flags: Frames_1.Flags.NONE,\n                            clientPosition: frameStore.firstAvailableFramePosition,\n                            serverPosition: frameStore.lastReceivedFramePosition,\n                            majorVersion: setupFrame.minorVersion,\n                            minorVersion: setupFrame.majorVersion,\n                            resumeToken: setupFrame.resumeToken\n                          });\n                          return new ClientServerMultiplexerDemultiplexer_1.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer(outbound, outbound, self);\n                        };\n                        reconnectionAttempts = -1;\n                        reconnector = function () {\n                          reconnectionAttempts++;\n                          return config.resume.reconnectFunction(reconnectionAttempts).then(function () {\n                            return config.transport.connect(multiplexerDemultiplexerProvider).catch(reconnector);\n                          });\n                        };\n                        return [4 /*yield*/, reconnector()];\n                      case 1:\n                        _a.sent();\n                        return [2 /*return*/];\n                    }\n                  });\n                });\n              }) : new ClientServerMultiplexerDemultiplexer_1.ClientServerInputMultiplexerDemultiplexer(ClientServerMultiplexerDemultiplexer_1.StreamIdGenerator.create(-1), outbound, outbound);\n            })];\n          case 1:\n            connection = _w.sent();\n            keepAliveSender = new RSocketSupport_1.KeepAliveSender(connection.multiplexerDemultiplexer.connectionOutbound, setupFrame.keepAlive);\n            keepAliveHandler = new RSocketSupport_1.KeepAliveHandler(connection, setupFrame.lifetime);\n            leaseHandler = config.lease ? new RSocketSupport_1.LeaseHandler((_s = config.lease.maxPendingRequests) !== null && _s !== void 0 ? _s : 256, connection.multiplexerDemultiplexer) : undefined;\n            responder = (_t = config.responder) !== null && _t !== void 0 ? _t : {};\n            connectionFrameHandler = new RSocketSupport_1.DefaultConnectionFrameHandler(connection, keepAliveHandler, keepAliveSender, leaseHandler, responder);\n            streamsHandler = new RSocketSupport_1.DefaultStreamRequestHandler(responder, 0);\n            connection.onClose(function (e) {\n              keepAliveSender.close();\n              keepAliveHandler.close();\n              connectionFrameHandler.close(e);\n            });\n            connection.multiplexerDemultiplexer.connectionInbound(connectionFrameHandler);\n            connection.multiplexerDemultiplexer.handleRequestStream(streamsHandler);\n            connection.multiplexerDemultiplexer.connectionOutbound.send(setupFrame);\n            keepAliveHandler.start();\n            keepAliveSender.start();\n            return [2 /*return*/, new RSocketSupport_1.RSocketRequester(connection, (_v = (_u = config.fragmentation) === null || _u === void 0 ? void 0 : _u.maxOutboundFragmentSize) !== null && _v !== void 0 ? _v : 0, leaseHandler)];\n        }\n      });\n    });\n  };\n  return RSocketConnector;\n}();\nexports.RSocketConnector = RSocketConnector;","map":{"version":3,"names":["require","ClientServerMultiplexerDemultiplexer_1","Frames_1","RSocketSupport_1","Resume_1","RSocketConnector","config","prototype","connect","setupFrame","type","FrameTypes","SETUP","dataMimeType","_b","_a","setup","metadataMimeType","_d","_c","keepAlive","_f","_e","lifetime","_h","_g","metadata","_k","_j","payload","data","_m","_l","resumeToken","_p","_o","resume","tokenGenerator","streamId","majorVersion","minorVersion","flags","_r","_q","Flags","METADATA","NONE","lease","LEASE","RESUME_ENABLE","transport","outbound","ResumableClientServerInputMultiplexerDemultiplexer","StreamIdGenerator","create","FrameStore","toString","self","frameStore","__awaiter","_this","multiplexerDemultiplexerProvider","send","RESUME","clientPosition","firstAvailableFramePosition","serverPosition","lastReceivedFramePosition","ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer","reconnectionAttempts","reconnector","reconnectFunction","then","catch","sent","ClientServerInputMultiplexerDemultiplexer","connection","_w","keepAliveSender","KeepAliveSender","multiplexerDemultiplexer","connectionOutbound","keepAliveHandler","KeepAliveHandler","leaseHandler","LeaseHandler","_s","maxPendingRequests","undefined","responder","_t","connectionFrameHandler","DefaultConnectionFrameHandler","streamsHandler","DefaultStreamRequestHandler","onClose","e","close","connectionInbound","handleRequestStream","start","RSocketRequester","_v","_u","fragmentation","maxOutboundFragmentSize","exports"],"sources":["../src/RSocketConnector.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}