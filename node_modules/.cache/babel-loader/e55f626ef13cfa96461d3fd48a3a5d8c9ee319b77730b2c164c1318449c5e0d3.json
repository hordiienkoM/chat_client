{"ast":null,"code":"\"use strict\";\n\n/*\n * Copyright 2021-2022 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nrequire(\"core-js/modules/es.array.push.js\");\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n    return extendStatics(d, b);\n  };\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n    extendStatics(d, b);\n    function __() {\n      this.constructor = d;\n    }\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n      label: 0,\n      sent: function () {\n        if (t[0] & 1) throw t[1];\n        return t[1];\n      },\n      trys: [],\n      ops: []\n    },\n    f,\n    y,\n    t,\n    g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n        case 7:\n          op = _.ops.pop();\n          _.trys.pop();\n          continue;\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n            _.ops.push(op);\n            break;\n          }\n          if (t[2]) _.ops.pop();\n          _.trys.pop();\n          continue;\n      }\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer = exports.ResumableClientServerInputMultiplexerDemultiplexer = exports.ClientServerInputMultiplexerDemultiplexer = exports.StreamIdGenerator = void 0;\nvar _1 = require(\".\");\nvar Deferred_1 = require(\"./Deferred\");\nvar Errors_1 = require(\"./Errors\");\nvar Frames_1 = require(\"./Frames\");\nvar StreamIdGenerator;\n(function (StreamIdGenerator) {\n  function create(seedId) {\n    return new StreamIdGeneratorImpl(seedId);\n  }\n  StreamIdGenerator.create = create;\n  var StreamIdGeneratorImpl = /** @class */function () {\n    function StreamIdGeneratorImpl(currentId) {\n      this.currentId = currentId;\n    }\n    StreamIdGeneratorImpl.prototype.next = function (handler) {\n      var nextId = this.currentId + 2;\n      if (!handler(nextId)) {\n        return;\n      }\n      this.currentId = nextId;\n    };\n    return StreamIdGeneratorImpl;\n  }();\n})(StreamIdGenerator = exports.StreamIdGenerator || (exports.StreamIdGenerator = {}));\nvar ClientServerInputMultiplexerDemultiplexer = /** @class */function (_super) {\n  __extends(ClientServerInputMultiplexerDemultiplexer, _super);\n  function ClientServerInputMultiplexerDemultiplexer(streamIdSupplier, outbound, closeable) {\n    var _this = _super.call(this) || this;\n    _this.streamIdSupplier = streamIdSupplier;\n    _this.outbound = outbound;\n    _this.closeable = closeable;\n    _this.registry = {};\n    closeable.onClose(_this.close.bind(_this));\n    return _this;\n  }\n  ClientServerInputMultiplexerDemultiplexer.prototype.handle = function (frame) {\n    if (Frames_1.Frame.isConnection(frame)) {\n      if (frame.type === _1.FrameTypes.RESERVED) {\n        // TODO: throw\n        return;\n      }\n      this.connectionFramesHandler.handle(frame);\n      // TODO: Connection Handler\n    } else if (Frames_1.Frame.isRequest(frame)) {\n      if (this.registry[frame.streamId]) {\n        // TODO: Send error and close connection\n        return;\n      }\n      this.requestFramesHandler.handle(frame, this);\n    } else {\n      var handler = this.registry[frame.streamId];\n      if (!handler) {\n        // TODO: add validation\n        return;\n      }\n      handler.handle(frame);\n    }\n    // TODO: add extensions support\n  };\n\n  ClientServerInputMultiplexerDemultiplexer.prototype.connectionInbound = function (handler) {\n    if (this.connectionFramesHandler) {\n      throw new Error(\"Connection frame handler has already been installed\");\n    }\n    this.connectionFramesHandler = handler;\n  };\n  ClientServerInputMultiplexerDemultiplexer.prototype.handleRequestStream = function (handler) {\n    if (this.requestFramesHandler) {\n      throw new Error(\"Stream handler has already been installed\");\n    }\n    this.requestFramesHandler = handler;\n  };\n  ClientServerInputMultiplexerDemultiplexer.prototype.send = function (frame) {\n    this.outbound.send(frame);\n  };\n  Object.defineProperty(ClientServerInputMultiplexerDemultiplexer.prototype, \"connectionOutbound\", {\n    get: function () {\n      return this;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  ClientServerInputMultiplexerDemultiplexer.prototype.createRequestStream = function (streamHandler) {\n    var _this = this;\n    // handle requester side stream registration\n    if (this.done) {\n      streamHandler.handleReject(new Error(\"Already closed\"));\n      return;\n    }\n    var registry = this.registry;\n    this.streamIdSupplier.next(function (streamId) {\n      return streamHandler.handleReady(streamId, _this);\n    }, Object.keys(registry));\n  };\n  ClientServerInputMultiplexerDemultiplexer.prototype.connect = function (handler) {\n    this.registry[handler.streamId] = handler;\n  };\n  ClientServerInputMultiplexerDemultiplexer.prototype.disconnect = function (stream) {\n    delete this.registry[stream.streamId];\n  };\n  ClientServerInputMultiplexerDemultiplexer.prototype.close = function (error) {\n    if (this.done) {\n      _super.prototype.close.call(this, error);\n      return;\n    }\n    for (var streamId in this.registry) {\n      var stream = this.registry[streamId];\n      stream.close(new Error(\"Closed. \".concat(error ? \"Original cause [\".concat(error, \"].\") : \"\")));\n    }\n    _super.prototype.close.call(this, error);\n  };\n  return ClientServerInputMultiplexerDemultiplexer;\n}(Deferred_1.Deferred);\nexports.ClientServerInputMultiplexerDemultiplexer = ClientServerInputMultiplexerDemultiplexer;\nvar ResumableClientServerInputMultiplexerDemultiplexer = /** @class */function (_super) {\n  __extends(ResumableClientServerInputMultiplexerDemultiplexer, _super);\n  function ResumableClientServerInputMultiplexerDemultiplexer(streamIdSupplier, outbound, closeable, frameStore, token, sessionStoreOrReconnector, sessionTimeout) {\n    var _this = _super.call(this, streamIdSupplier, outbound, new Deferred_1.Deferred()) || this;\n    _this.frameStore = frameStore;\n    _this.token = token;\n    _this.sessionTimeout = sessionTimeout;\n    if (sessionStoreOrReconnector instanceof Function) {\n      _this.reconnector = sessionStoreOrReconnector;\n    } else {\n      _this.sessionStore = sessionStoreOrReconnector;\n    }\n    closeable.onClose(_this.handleConnectionClose.bind(_this));\n    return _this;\n  }\n  ResumableClientServerInputMultiplexerDemultiplexer.prototype.send = function (frame) {\n    if (Frames_1.Frame.isConnection(frame)) {\n      if (frame.type === _1.FrameTypes.KEEPALIVE) {\n        frame.lastReceivedPosition = this.frameStore.lastReceivedFramePosition;\n      } else if (frame.type === _1.FrameTypes.ERROR) {\n        this.outbound.send(frame);\n        if (this.sessionStore) {\n          delete this.sessionStore[this.token];\n        }\n        _super.prototype.close.call(this, new Errors_1.RSocketError(frame.code, frame.message));\n        return;\n      }\n    } else {\n      this.frameStore.store(frame);\n    }\n    this.outbound.send(frame);\n  };\n  ResumableClientServerInputMultiplexerDemultiplexer.prototype.handle = function (frame) {\n    if (Frames_1.Frame.isConnection(frame)) {\n      if (frame.type === _1.FrameTypes.KEEPALIVE) {\n        try {\n          this.frameStore.dropTo(frame.lastReceivedPosition);\n        } catch (re) {\n          this.outbound.send({\n            type: _1.FrameTypes.ERROR,\n            streamId: 0,\n            flags: _1.Flags.NONE,\n            code: re.code,\n            message: re.message\n          });\n          this.close(re);\n        }\n      } else if (frame.type === _1.FrameTypes.ERROR) {\n        _super.prototype.handle.call(this, frame);\n        if (this.sessionStore) {\n          delete this.sessionStore[this.token];\n        }\n        _super.prototype.close.call(this, new Errors_1.RSocketError(frame.code, frame.message));\n        return;\n      }\n    } else {\n      this.frameStore.record(frame);\n    }\n    _super.prototype.handle.call(this, frame);\n  };\n  ResumableClientServerInputMultiplexerDemultiplexer.prototype.resume = function (frame, outbound, closeable) {\n    this.outbound = outbound;\n    switch (frame.type) {\n      case _1.FrameTypes.RESUME:\n        {\n          clearTimeout(this.timeoutId);\n          if (this.frameStore.lastReceivedFramePosition < frame.clientPosition) {\n            var e = new Errors_1.RSocketError(_1.ErrorCodes.REJECTED_RESUME, \"Impossible to resume since first available client frame position is greater than last received server frame position\");\n            this.outbound.send({\n              type: _1.FrameTypes.ERROR,\n              streamId: 0,\n              flags: _1.Flags.NONE,\n              code: e.code,\n              message: e.message\n            });\n            this.close(e);\n            return;\n          }\n          try {\n            this.frameStore.dropTo(frame.serverPosition);\n          } catch (re) {\n            this.outbound.send({\n              type: _1.FrameTypes.ERROR,\n              streamId: 0,\n              flags: _1.Flags.NONE,\n              code: re.code,\n              message: re.message\n            });\n            this.close(re);\n            return;\n          }\n          this.outbound.send({\n            type: _1.FrameTypes.RESUME_OK,\n            streamId: 0,\n            flags: _1.Flags.NONE,\n            clientPosition: this.frameStore.lastReceivedFramePosition\n          });\n          break;\n        }\n      case _1.FrameTypes.RESUME_OK:\n        {\n          try {\n            this.frameStore.dropTo(frame.clientPosition);\n          } catch (re) {\n            this.outbound.send({\n              type: _1.FrameTypes.ERROR,\n              streamId: 0,\n              flags: _1.Flags.NONE,\n              code: re.code,\n              message: re.message\n            });\n            this.close(re);\n          }\n          break;\n        }\n    }\n    this.frameStore.drain(this.outbound.send.bind(this.outbound));\n    closeable.onClose(this.handleConnectionClose.bind(this));\n    this.connectionFramesHandler.resume();\n  };\n  ResumableClientServerInputMultiplexerDemultiplexer.prototype.handleConnectionClose = function (_error) {\n    return __awaiter(this, void 0, void 0, function () {\n      var e_1;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            this.connectionFramesHandler.pause();\n            if (!this.reconnector) return [3 /*break*/, 5];\n            _a.label = 1;\n          case 1:\n            _a.trys.push([1, 3,, 4]);\n            return [4 /*yield*/, this.reconnector(this, this.frameStore)];\n          case 2:\n            _a.sent();\n            return [3 /*break*/, 4];\n          case 3:\n            e_1 = _a.sent();\n            this.close(e_1);\n            return [3 /*break*/, 4];\n          case 4:\n            return [3 /*break*/, 6];\n          case 5:\n            this.timeoutId = setTimeout(this.close.bind(this), this.sessionTimeout);\n            _a.label = 6;\n          case 6:\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n\n  return ResumableClientServerInputMultiplexerDemultiplexer;\n}(ClientServerInputMultiplexerDemultiplexer);\nexports.ResumableClientServerInputMultiplexerDemultiplexer = ResumableClientServerInputMultiplexerDemultiplexer;\nvar ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer = /** @class */function () {\n  function ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer(outbound, closeable, delegate) {\n    this.outbound = outbound;\n    this.closeable = closeable;\n    this.delegate = delegate;\n    this.resumed = false;\n  }\n  ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer.prototype.close = function () {\n    this.delegate.close();\n  };\n  ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer.prototype.onClose = function (callback) {\n    this.delegate.onClose(callback);\n  };\n  Object.defineProperty(ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer.prototype, \"connectionOutbound\", {\n    get: function () {\n      return this.delegate.connectionOutbound;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer.prototype.createRequestStream = function (streamHandler) {\n    this.delegate.createRequestStream(streamHandler);\n  };\n  ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer.prototype.connectionInbound = function (handler) {\n    this.delegate.connectionInbound(handler);\n  };\n  ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer.prototype.handleRequestStream = function (handler) {\n    this.delegate.handleRequestStream(handler);\n  };\n  ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer.prototype.handle = function (frame) {\n    var _this = this;\n    if (!this.resumed) {\n      if (frame.type === _1.FrameTypes.RESUME_OK) {\n        this.resumed = true;\n        this.delegate.resume(frame, this.outbound, this.closeable);\n        return;\n      } else {\n        this.outbound.send({\n          type: _1.FrameTypes.ERROR,\n          streamId: 0,\n          code: _1.ErrorCodes.CONNECTION_ERROR,\n          message: \"Incomplete RESUME handshake. Unexpected frame \".concat(frame.type, \" received\"),\n          flags: _1.Flags.NONE\n        });\n        this.closeable.close();\n        this.closeable.onClose(function () {\n          return _this.delegate.close(new Errors_1.RSocketError(_1.ErrorCodes.CONNECTION_ERROR, \"Incomplete RESUME handshake. Unexpected frame \".concat(frame.type, \" received\")));\n        });\n      }\n      return;\n    }\n    this.delegate.handle(frame);\n  };\n  return ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer;\n}();\nexports.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer = ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer;","map":{"version":3,"names":["require","_1","Deferred_1","Errors_1","Frames_1","StreamIdGenerator","create","seedId","StreamIdGeneratorImpl","currentId","prototype","next","handler","nextId","exports","ClientServerInputMultiplexerDemultiplexer","_super","__extends","streamIdSupplier","outbound","closeable","_this","call","registry","onClose","close","bind","handle","frame","Frame","isConnection","type","FrameTypes","RESERVED","connectionFramesHandler","isRequest","streamId","requestFramesHandler","connectionInbound","Error","handleRequestStream","send","Object","defineProperty","get","createRequestStream","streamHandler","done","handleReject","handleReady","keys","connect","disconnect","stream","error","concat","Deferred","ResumableClientServerInputMultiplexerDemultiplexer","frameStore","token","sessionStoreOrReconnector","sessionTimeout","Function","reconnector","sessionStore","handleConnectionClose","KEEPALIVE","lastReceivedPosition","lastReceivedFramePosition","ERROR","RSocketError","code","message","store","dropTo","re","flags","Flags","NONE","record","resume","RESUME","clearTimeout","timeoutId","clientPosition","e","ErrorCodes","REJECTED_RESUME","serverPosition","RESUME_OK","drain","_error","pause","_a","sent","e_1","setTimeout","ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer","delegate","resumed","callback","connectionOutbound","CONNECTION_ERROR"],"sources":["../src/ClientServerMultiplexerDemultiplexer.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}