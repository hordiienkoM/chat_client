{"ast":null,"code":"\"use strict\";\n\n/*\n * Copyright 2021-2022 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nrequire(\"core-js/modules/es.array.push.js\");\nvar __values = this && this.__values || function (o) {\n  var s = typeof Symbol === \"function\" && Symbol.iterator,\n    m = s && o[s],\n    i = 0;\n  if (m) return m.call(o);\n  if (o && typeof o.length === \"number\") return {\n    next: function () {\n      if (o && i >= o.length) o = void 0;\n      return {\n        value: o && o[i++],\n        done: !o\n      };\n    }\n  };\n  throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.FrameStore = void 0;\nvar _1 = require(\".\");\nvar Codecs_1 = require(\"./Codecs\");\nvar FrameStore = /** @class */function () {\n  function FrameStore() {\n    this.storedFrames = [];\n    this._lastReceivedFramePosition = 0;\n    this._firstAvailableFramePosition = 0;\n    this._lastSentFramePosition = 0;\n  }\n  Object.defineProperty(FrameStore.prototype, \"lastReceivedFramePosition\", {\n    get: function () {\n      return this._lastReceivedFramePosition;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(FrameStore.prototype, \"firstAvailableFramePosition\", {\n    get: function () {\n      return this._firstAvailableFramePosition;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(FrameStore.prototype, \"lastSentFramePosition\", {\n    get: function () {\n      return this._lastSentFramePosition;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  FrameStore.prototype.store = function (frame) {\n    this._lastSentFramePosition += (0, Codecs_1.sizeOfFrame)(frame);\n    this.storedFrames.push(frame);\n  };\n  FrameStore.prototype.record = function (frame) {\n    this._lastReceivedFramePosition += (0, Codecs_1.sizeOfFrame)(frame);\n  };\n  FrameStore.prototype.dropTo = function (lastReceivedPosition) {\n    var bytesToDrop = lastReceivedPosition - this._firstAvailableFramePosition;\n    while (bytesToDrop > 0 && this.storedFrames.length > 0) {\n      var storedFrame = this.storedFrames.shift();\n      bytesToDrop -= (0, Codecs_1.sizeOfFrame)(storedFrame);\n    }\n    if (bytesToDrop !== 0) {\n      throw new _1.RSocketError(_1.ErrorCodes.CONNECTION_ERROR, \"State inconsistency. Expected bytes to drop \".concat(lastReceivedPosition - this._firstAvailableFramePosition, \" but actual \").concat(bytesToDrop));\n    }\n    this._firstAvailableFramePosition = lastReceivedPosition;\n  };\n  FrameStore.prototype.drain = function (consumer) {\n    var e_1, _a;\n    try {\n      for (var _b = __values(this.storedFrames), _c = _b.next(); !_c.done; _c = _b.next()) {\n        var frame = _c.value;\n        consumer(frame);\n      }\n    } catch (e_1_1) {\n      e_1 = {\n        error: e_1_1\n      };\n    } finally {\n      try {\n        if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n      } finally {\n        if (e_1) throw e_1.error;\n      }\n    }\n  };\n  return FrameStore;\n}();\nexports.FrameStore = FrameStore;","map":{"version":3,"names":["require","_1","Codecs_1","FrameStore","storedFrames","_lastReceivedFramePosition","_firstAvailableFramePosition","_lastSentFramePosition","Object","defineProperty","prototype","get","store","frame","sizeOfFrame","push","record","dropTo","lastReceivedPosition","bytesToDrop","length","storedFrame","shift","RSocketError","ErrorCodes","CONNECTION_ERROR","concat","drain","consumer","_b","__values","_c","next","done","value","exports"],"sources":["../src/Resume.ts"],"sourcesContent":[null],"mappings":";;AAAA;;;;;;;;;;;;;;;AAAAA,OAAA;;;;;;;;;;;;;;;;;;;;;AAgBA,IAAAC,EAAA,GAAAD,OAAA;AACA,IAAAE,QAAA,GAAAF,OAAA;AAaA,IAAAG,UAAA;EAAA,SAAAA,WAAA;IACmB,KAAAC,YAAY,GAWzB,EAAE;IACE,KAAAC,0BAA0B,GAAW,CAAC;IACtC,KAAAC,4BAA4B,GAAW,CAAC;IACxC,KAAAC,sBAAsB,GAAW,CAAC;EAqF5C;EAnFEC,MAAA,CAAAC,cAAA,CAAIN,UAAA,CAAAO,SAAA,6BAAyB;SAA7B,SAAAC,CAAA;MACE,OAAO,IAAI,CAACN,0BAA0B;IACxC,CAAC;;;;EAEDG,MAAA,CAAAC,cAAA,CAAIN,UAAA,CAAAO,SAAA,+BAA2B;SAA/B,SAAAC,CAAA;MACE,OAAO,IAAI,CAACL,4BAA4B;IAC1C,CAAC;;;;EAEDE,MAAA,CAAAC,cAAA,CAAIN,UAAA,CAAAO,SAAA,yBAAqB;SAAzB,SAAAC,CAAA;MACE,OAAO,IAAI,CAACJ,sBAAsB;IACpC,CAAC;;;;EAEDJ,UAAA,CAAAO,SAAA,CAAAE,KAAK,GAAL,UACEC,KAUY;IAEZ,IAAI,CAACN,sBAAsB,IAAI,IAAAL,QAAA,CAAAY,WAAW,EAACD,KAAK,CAAC;IACjD,IAAI,CAACT,YAAY,CAACW,IAAI,CAACF,KAAK,CAAC;EAC/B,CAAC;EAEDV,UAAA,CAAAO,SAAA,CAAAM,MAAM,GAAN,UACEH,KAUY;IAEZ,IAAI,CAACR,0BAA0B,IAAI,IAAAH,QAAA,CAAAY,WAAW,EAACD,KAAK,CAAC;EACvD,CAAC;EAEDV,UAAA,CAAAO,SAAA,CAAAO,MAAM,GAAN,UAAOC,oBAA4B;IACjC,IAAIC,WAAW,GAAGD,oBAAoB,GAAG,IAAI,CAACZ,4BAA4B;IAC1E,OAAOa,WAAW,GAAG,CAAC,IAAI,IAAI,CAACf,YAAY,CAACgB,MAAM,GAAG,CAAC,EAAE;MACtD,IAAMC,WAAW,GAAG,IAAI,CAACjB,YAAY,CAACkB,KAAK,EAAE;MAC7CH,WAAW,IAAI,IAAAjB,QAAA,CAAAY,WAAW,EAACO,WAAW,CAAC;;IAGzC,IAAIF,WAAW,KAAK,CAAC,EAAE;MACrB,MAAM,IAAIlB,EAAA,CAAAsB,YAAY,CACpBtB,EAAA,CAAAuB,UAAU,CAACC,gBAAgB,EAC3B,+CAAAC,MAAA,CACER,oBAAoB,GAAG,IAAI,CAACZ,4BAA4B,kBAAAoB,MAAA,CAC3CP,WAAW,CAAE,CAC7B;;IAGH,IAAI,CAACb,4BAA4B,GAAGY,oBAAoB;EAC1D,CAAC;EAEDf,UAAA,CAAAO,SAAA,CAAAiB,KAAK,GAAL,UACEC,QAYS;;;MAET,KAAoB,IAAAC,EAAA,GAAAC,QAAA,KAAI,CAAC1B,YAAY,GAAA2B,EAAA,GAAAF,EAAA,CAAAG,IAAA,KAAAD,EAAA,CAAAE,IAAA,EAAAF,EAAA,GAAAF,EAAA,CAAAG,IAAA,IAAE;QAAlC,IAAMnB,KAAK,GAAAkB,EAAA,CAAAG,KAAA;QACdN,QAAQ,CAACf,KAAK,CAAC;;;;;;;;;;;;;EAEnB,CAAC;EACH,OAAAV,UAAC;AAAD,CAAC,CApGD;AAAagC,OAAA,CAAAhC,UAAA,GAAAA,UAAA"},"metadata":{},"sourceType":"script","externalDependencies":[]}