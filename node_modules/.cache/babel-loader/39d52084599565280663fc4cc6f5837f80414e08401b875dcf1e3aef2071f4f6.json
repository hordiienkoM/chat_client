{"ast":null,"code":"\"use strict\";\n\n/*\n * Copyright 2021-2022 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n    return extendStatics(d, b);\n  };\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n    extendStatics(d, b);\n    function __() {\n      this.constructor = d;\n    }\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.WebsocketDuplexConnection = void 0;\nvar rsocket_core_1 = require(\"rsocket-core\");\nvar WebsocketDuplexConnection = /** @class */function (_super) {\n  __extends(WebsocketDuplexConnection, _super);\n  function WebsocketDuplexConnection(websocket, deserializer, multiplexerDemultiplexerFactory) {\n    var _this = _super.call(this) || this;\n    _this.websocket = websocket;\n    _this.deserializer = deserializer;\n    _this.handleClosed = function (e) {\n      _this.close(new Error(e.reason || \"WebsocketDuplexConnection: Socket closed unexpectedly.\"));\n    };\n    _this.handleError = function (e) {\n      _this.close(e.error);\n    };\n    _this.handleMessage = function (message) {\n      try {\n        var buffer = Buffer.from(message.data);\n        var frame = _this.deserializer.deserializeFrame(buffer);\n        _this.multiplexerDemultiplexer.handle(frame);\n      } catch (error) {\n        _this.close(error);\n      }\n    };\n    websocket.addEventListener(\"close\", _this.handleClosed);\n    websocket.addEventListener(\"error\", _this.handleError);\n    websocket.addEventListener(\"message\", _this.handleMessage);\n    _this.multiplexerDemultiplexer = multiplexerDemultiplexerFactory(_this);\n    return _this;\n  }\n  Object.defineProperty(WebsocketDuplexConnection.prototype, \"availability\", {\n    get: function () {\n      return this.done ? 0 : 1;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  WebsocketDuplexConnection.prototype.close = function (error) {\n    if (this.done) {\n      _super.prototype.close.call(this, error);\n      return;\n    }\n    this.websocket.removeEventListener(\"close\", this.handleClosed);\n    this.websocket.removeEventListener(\"error\", this.handleError);\n    this.websocket.removeEventListener(\"message\", this.handleMessage);\n    this.websocket.close();\n    delete this.websocket;\n    _super.prototype.close.call(this, error);\n  };\n  WebsocketDuplexConnection.prototype.send = function (frame) {\n    if (this.done) {\n      return;\n    }\n    var buffer = (0, rsocket_core_1.serializeFrame)(frame);\n    this.websocket.send(buffer);\n  };\n  return WebsocketDuplexConnection;\n}(rsocket_core_1.Deferred);\nexports.WebsocketDuplexConnection = WebsocketDuplexConnection;","map":{"version":3,"names":["rsocket_core_1","require","WebsocketDuplexConnection","_super","__extends","websocket","deserializer","multiplexerDemultiplexerFactory","_this","call","handleClosed","e","close","Error","reason","handleError","error","handleMessage","message","buffer","Buffer","from","data","frame","deserializeFrame","multiplexerDemultiplexer","handle","addEventListener","Object","defineProperty","prototype","get","done","removeEventListener","send","serializeFrame","Deferred","exports"],"sources":["../src/WebsocketDuplexConnection.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}