{"ast":null,"code":"\"use strict\";\n\n/*\n * Copyright 2021-2022 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nrequire(\"core-js/modules/es.regexp.flags.js\");\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nvar __values = this && this.__values || function (o) {\n  var s = typeof Symbol === \"function\" && Symbol.iterator,\n    m = s && o[s],\n    i = 0;\n  if (m) return m.call(o);\n  if (o && typeof o.length === \"number\") return {\n    next: function () {\n      if (o && i >= o.length) o = void 0;\n      return {\n        value: o && o[i++],\n        done: !o\n      };\n    }\n  };\n  throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.RequestFnfResponderStream = exports.RequestFnFRequesterStream = void 0;\nvar Errors_1 = require(\"./Errors\");\nvar Fragmenter_1 = require(\"./Fragmenter\");\nvar Frames_1 = require(\"./Frames\");\nvar Reassembler = __importStar(require(\"./Reassembler\"));\nvar RequestFnFRequesterStream = /** @class */function () {\n  function RequestFnFRequesterStream(payload, receiver, fragmentSize, leaseManager) {\n    this.payload = payload;\n    this.receiver = receiver;\n    this.fragmentSize = fragmentSize;\n    this.leaseManager = leaseManager;\n    this.streamType = Frames_1.FrameTypes.REQUEST_FNF;\n  }\n  RequestFnFRequesterStream.prototype.handleReady = function (streamId, stream) {\n    var e_1, _a;\n    if (this.done) {\n      return false;\n    }\n    this.streamId = streamId;\n    if ((0, Fragmenter_1.isFragmentable)(this.payload, this.fragmentSize, Frames_1.FrameTypes.REQUEST_FNF)) {\n      try {\n        for (var _b = __values((0, Fragmenter_1.fragment)(streamId, this.payload, this.fragmentSize, Frames_1.FrameTypes.REQUEST_FNF)), _c = _b.next(); !_c.done; _c = _b.next()) {\n          var frame = _c.value;\n          stream.send(frame);\n        }\n      } catch (e_1_1) {\n        e_1 = {\n          error: e_1_1\n        };\n      } finally {\n        try {\n          if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n        } finally {\n          if (e_1) throw e_1.error;\n        }\n      }\n    } else {\n      stream.send({\n        type: Frames_1.FrameTypes.REQUEST_FNF,\n        data: this.payload.data,\n        metadata: this.payload.metadata,\n        flags: this.payload.metadata ? Frames_1.Flags.METADATA : 0,\n        streamId: streamId\n      });\n    }\n    this.done = true;\n    this.receiver.onComplete();\n    return true;\n  };\n  RequestFnFRequesterStream.prototype.handleReject = function (error) {\n    if (this.done) {\n      return;\n    }\n    this.done = true;\n    this.receiver.onError(error);\n  };\n  RequestFnFRequesterStream.prototype.cancel = function () {\n    var _a;\n    if (this.done) {\n      return;\n    }\n    this.done = true;\n    (_a = this.leaseManager) === null || _a === void 0 ? void 0 : _a.cancelRequest(this);\n  };\n  RequestFnFRequesterStream.prototype.handle = function (frame) {\n    if (frame.type == Frames_1.FrameTypes.ERROR) {\n      this.close(new Errors_1.RSocketError(frame.code, frame.message));\n      return;\n    }\n    this.close(new Errors_1.RSocketError(Errors_1.ErrorCodes.CANCELED, \"Received invalid frame\"));\n  };\n  RequestFnFRequesterStream.prototype.close = function (error) {\n    if (this.done) {\n      console.warn(\"Trying to close for the second time. \".concat(error ? \"Dropping error [\".concat(error, \"].\") : \"\"));\n      return;\n    }\n    if (error) {\n      this.receiver.onError(error);\n    } else {\n      this.receiver.onComplete();\n    }\n  };\n  return RequestFnFRequesterStream;\n}();\nexports.RequestFnFRequesterStream = RequestFnFRequesterStream;\nvar RequestFnfResponderStream = /** @class */function () {\n  function RequestFnfResponderStream(streamId, stream, handler, frame) {\n    this.streamId = streamId;\n    this.stream = stream;\n    this.handler = handler;\n    this.streamType = Frames_1.FrameTypes.REQUEST_FNF;\n    if (Frames_1.Flags.hasFollows(frame.flags)) {\n      Reassembler.add(this, frame.data, frame.metadata);\n      stream.connect(this);\n      return;\n    }\n    var payload = {\n      data: frame.data,\n      metadata: frame.metadata\n    };\n    try {\n      this.cancellable = handler(payload, this);\n    } catch (e) {\n      // do nothing\n    }\n  }\n  RequestFnfResponderStream.prototype.handle = function (frame) {\n    var errorMessage;\n    if (frame.type == Frames_1.FrameTypes.PAYLOAD) {\n      if (Frames_1.Flags.hasFollows(frame.flags)) {\n        if (Reassembler.add(this, frame.data, frame.metadata)) {\n          return;\n        }\n        errorMessage = \"Unexpected fragment size\";\n      } else {\n        this.stream.disconnect(this);\n        var payload = Reassembler.reassemble(this, frame.data, frame.metadata);\n        try {\n          this.cancellable = this.handler(payload, this);\n        } catch (e) {\n          // do nothing\n        }\n        return;\n      }\n    } else {\n      errorMessage = \"Unexpected frame type [\".concat(frame.type, \"]\");\n    }\n    this.done = true;\n    if (frame.type != Frames_1.FrameTypes.CANCEL && frame.type != Frames_1.FrameTypes.ERROR) {\n      this.stream.send({\n        type: Frames_1.FrameTypes.ERROR,\n        streamId: this.streamId,\n        flags: Frames_1.Flags.NONE,\n        code: Errors_1.ErrorCodes.CANCELED,\n        message: errorMessage\n      });\n    }\n    this.stream.disconnect(this);\n    Reassembler.cancel(this);\n    // TODO: throws if strict\n  };\n\n  RequestFnfResponderStream.prototype.close = function (error) {\n    var _a;\n    if (this.done) {\n      console.warn(\"Trying to close for the second time. \".concat(error ? \"Dropping error [\".concat(error, \"].\") : \"\"));\n      return;\n    }\n    this.done = true;\n    Reassembler.cancel(this);\n    (_a = this.cancellable) === null || _a === void 0 ? void 0 : _a.cancel();\n  };\n  RequestFnfResponderStream.prototype.onError = function (error) {};\n  RequestFnfResponderStream.prototype.onComplete = function () {};\n  return RequestFnfResponderStream;\n}();\nexports.RequestFnfResponderStream = RequestFnfResponderStream;\n/*\nexport function request(\n  payload: Payload,\n  responderStream: UnidirectionalStream\n): Handler<Cancellable> {\n  return {\n    create: (r) => {\n      const response = new RequestFnFRequesterHandler(\n        payload,\n        responderStream,\n        r\n      );\n\n      r.add(response);\n\n      return response;\n    },\n  };\n}\n\nexport function response(\n  handler: (payload: Payload, responderStream: UnidirectionalStream,) => void\n): Handler<void> {\n  return {\n    create: (r) => new RequestFnfResponderHandler(),\n  };\n} */","map":{"version":3,"names":["require","Errors_1","Fragmenter_1","Frames_1","Reassembler","__importStar","RequestFnFRequesterStream","payload","receiver","fragmentSize","leaseManager","streamType","FrameTypes","REQUEST_FNF","prototype","handleReady","streamId","stream","done","isFragmentable","_b","__values","fragment","_c","next","frame","value","send","type","data","metadata","flags","Flags","METADATA","onComplete","handleReject","error","onError","cancel","_a","cancelRequest","handle","ERROR","close","RSocketError","code","message","ErrorCodes","CANCELED","console","warn","concat","exports","RequestFnfResponderStream","handler","hasFollows","add","connect","cancellable","e","errorMessage","PAYLOAD","disconnect","reassemble","CANCEL","NONE"],"sources":["../src/RequestFnFStream.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}